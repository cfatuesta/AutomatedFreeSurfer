### README

#### Description:
These scripts process T1 images in a BIDS-formatted dataset using FreeSurfer's recon-all and the hippocampal and amygdala subfields segmentation stream, create a quality control montage of the FreeSurfer output for each subject and session, and extract the metrics into a CSV file. It runs the longitudinal stream if there's more than one session per subject.

They were designed to run with minimal user input. You will be presented with a series of questions that you need to answer in order to start specific processes. 

#### Author:
- Carolina Ferreira-Atuesta (September 2023)
- Email: cfatuesta@gmail.com

#### Prerequisites:
- Dataset must be organized according to the BIDS specification, including correctly named main directory and subdirectories.
  ![Image 18-09-2023 at 07 47](https://github.com/cfatuesta/ENIGMA/assets/42354106/2b7a68fc-4eb7-4d45-9283-e2142f4b0859)
- The images should be in nifti format (.nii or .nii.gz), and should be accompanied by their corresponding .JSON file. These two files are generated by common DICOM to NIFTI convertors such as dcm2niix (beware that dcm2nii is different to dcm2niix, please use the later)
- FreeSurfer must be installed, and the following scripts should be in your `SUBJECTS_DIR` path (this corresponds to the Enigma folder on the picture above) : `main_script.sh`, `process_csv.py`, `merge_csv.py`, and `process_longitudinal.py`.
- FreeSurfer's `freeview` and ImageMagick's `magick` command should be available in your system. To install ImageMagick, you can run: `brew install imagemagick`.
- Make sure you have python3 installed. Run `python --version` from your terminal to check which version you have. If its not python3, run:
  - `brew install pyenv`
  - `pyenv install 3.10.10`
  - `pyenv global 3.10.10`

** if you don't have homebrew (needed to be able to execute the "brew" commands) installed, run this before installing any package:
  - `/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`

** if you don't have dcm2niix, install it from here: `https://github.com/rordenlab/dcm2niix`

#### Instructions:

1. **Starting the Main Script**:
   Run the script `main_script.sh` in your terminal. If the dataset isn't organized and named correctly, press `Ctrl+C` to exit. Otherwise, press `Enter` to continue.

2. **Enter Paths**:
   - If `SUBJECTS_DIR` and `FREESURFER_HOME` are not set, you will be prompted to enter the paths to the SUBJECTS dataset and Freesurfer installation.
   - If they are set, confirm or re-enter the paths.

3. **Processing T1 Images**:
   - The script will display all found T1 images and extract the metadata from their headers. This section reads the .JSON files for all available T1s in the project and generates a CSV file named "T1s_metdata.csv" in the working directory. 
   - After this, the script will look for the T1s that have not been processed through Freesurfer by finding and reading the recon-all.log. If the log says "finished without error", the script will skip this file. If the log does not exist or says "finished with errors" it will be selected for processing.
   - After finding all unprocessed files, it asks whether to process the images through the cross-sectional pipeline. Type `yes` to proceed.

    ❗️ 	If you have T1s that have been processed through Freesurfer, but the outputs are located in a different directory, relocate them to the designated subject directory: 

   Please make sure to follow the given path specifications while relocating the output folders.
   It is crucial to also copy the “log” folder and all of its files to the new location, as the scripts use the information in these logs to determine whether additional processing is needed for the T1s.

4. **Generating Montages**:
   - If there are T1 images without montages, the script will ask whether to generate montages for these images. Type `yes` to proceed.
   - Two montages are generated for each subject/session - see below for examples:
     ![montage-3d](https://github.com/cfatuesta/ENIGMA/assets/42354106/15cd17f8-269a-4f8a-9953-2d88a9b00b8d)
      ![montage-2d](https://github.com/cfatuesta/ENIGMA/assets/42354106/82049d88-13a3-4ab8-963a-92ca5d40575d)


5. **Tables Creation**:
   - The script will create tables with all the cross-sectional and longitudinal data if available.
   - See the image below for an example of a generated file. 
   
      <img width="901" alt="Screenshot 2023-09-21 at 09 52 23" src="https://github.com/cfatuesta/ENIGMA/assets/42354106/9be972e4-eb75-48de-89ce-ddd4bff44b1b">

7. **Longitudinal stream**:
   - The script checks if there is more than 1 session per subject with already processed T1s.
   - If this is satisfied, the script will run Freesurfer's longitudinal pipeline, creating new folders for each output (base, time 1, and time 2)

#### Usage Example:
```sh
bash main_script.sh 
```

#### Output:
- Quality control montage of Freesurfer's output for each subject and session.
- Freesurfer's metrics extracted into a CSV file.
- Longitudinal stream data if there's more than one session per subject.
- Metadata for each unique T1 extracted into a CSV file

#### Notes:
- Do not change the names of the required scripts in your `SUBJECTS_DIR` path.
- Always make sure that the paths entered are correct to avoid errors.
- Ensure your dataset is well-organized and correctly named, following the BIDS specification, before running the script.

#### Troubleshooting:
- If the `freeview` or `magick` commands are not found, follow the error message instructions to install the missing software.
- If entered paths do not exist or are not directories, you will receive an error message, and the script will exit. Double-check your paths and try again.

#### Contact:
For any questions or issues, please contact Carolina Ferreira-Atuesta at cfatuesta@gmail.com.

